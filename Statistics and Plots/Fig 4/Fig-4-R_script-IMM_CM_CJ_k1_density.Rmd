---
title: "Fig 4 D, E, F, H; IMM, CM, CJ, high k1 density"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  html_document:
    theme: darkly
    highlight: breezedark
    df_print: paged
---


```{r setup, include=FALSE}

# Global chunk options: hide messages & warnings everywhere
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

<hr style="border:1px solid white"/>

**Column Descriptions**

- **Date**: date of imaging or experiment (format: YYYY-MM-DD)  
- **Condition**: experimental condition (e.g., *Control*, *TTX*)  
- **Dish**: dish or coverslip identifier (used for batch tracking)  
- **Cell**: cell identifier within the dish  
- **Mito_ID**: mito roi identifier within the condition 
- **OMM_vol**: volume of mito within the EM section (volume of outer mito membrane mesh)
- **IMM_sa**: inner mito membrane surface area
- **CM_sa**: cristae membrane surface area
- **CJ_n**: cristae junctions count
- **high_k1_sa**: high first principal curvature (k1 > 80 µm⁻¹) cristae membrane surface area
- **IMM_den**: IMM_sa / OMM_vol
- **CM_den**: CM_sa / OMM_vol
- **CJ_den**: CJ_sa / OMM_vol
- **high_k1_den**: high_k1_sa / OMM_vol
- **hull_diameter**: convex hull diameter ~ mito length (length of outer mito membrane mesh)
- **bounding_thickness**: thickness of the tomogram ~ thickness EM section in µm

<hr style="border:1px solid white"/>

**Fig 4 D**
```{r}
# === Libraries ===
library(dplyr)
library(readr)
library(ggplot2)
library(ggbeeswarm)
library(rstatix)
library(car)        # for Levene's test
library(ggtext)     # for element_markdown()

# === Read and prepare data ===
Density <- read_csv("./IMM_CM_CJ_k1_density.csv")
Density %>% arrange(Date, Condition, Dish, Cell, Mito_ID)
# === Animals per condition (check) ===
Density %>%
  distinct(Date, Condition) %>%
  count(Condition, name = "n_animal")
# === Cells per condition (check) ===
Density %>%
  distinct(Date, Condition, Dish, Cell) %>%
  count(Condition, name = "n_cell")
# === Spines per condition (check) ===
Density %>%
  count(Condition, name = "n_mito")


# === Normality and test selection ===
if (TRUE) {
  
  # 1. Shapiro-Wilk test for normality per group
  shapiro_results <- Density %>%
    group_by(Condition) %>%
    summarise(
      shapiro_p = shapiro.test(IMM_den)$p.value,
      .groups = "drop"
    )
  shapiro_results
  
  # 2. If all groups pass Shapiro -> check variance with Levene
  if (all(shapiro_results$shapiro_p > 0.05)) {
    levene <- leveneTest(IMM_den ~ Condition, data = Density, center = median)
    levene
    
    # 3a. Equal variances -> Student’s t-test
    if (levene$`Pr(>F)`[1] > 0.05) {
      stat_res <- t.test(IMM_den ~ Condition, data = Density, var.equal = TRUE)
      test_used <- "Student's t-test"
      
    # 3b. Unequal variances -> Welch’s t-test
    } else {
      stat_res <- t.test(IMM_den ~ Condition, data = Density, var.equal = FALSE)
      test_used <- "Welch's t-test"
    }
    
  # 4. If any group fails Shapiro -> Wilcoxon rank-sum
  } else {
    stat_res <- wilcox.test(IMM_den ~ Condition, data = Density, exact = FALSE)
    test_used <- "Wilcoxon rank-sum test"
  }
  
  # Output
  test_used
  stat_res
}

# === Prepare data for plotting ===
spacing_map <- c("Control" = 1, "TTX" = 2.2)
Density <- Density %>%
  filter(Condition %in% names(spacing_map)) %>%
  mutate(
    x_pos = spacing_map[Condition],
    Condition = factor(Condition, levels = c("Control", "TTX"))
  )

# === Build annotation (stars) ===
pval <- stat_res$p.value
p.signif <- case_when(
  pval < 0.0001 ~ "****",
  pval < 0.001  ~ "***",
  pval < 0.01   ~ "**",
  pval < 0.05   ~ "*",
  TRUE          ~ "ns"
)

test_results <- tibble(
  group1_x = spacing_map["Control"],
  group2_x = spacing_map["TTX"],
  y.position = 47,
  p.signif = p.signif
)

# === Final plot ===
ggplot(Density, aes(x = x_pos, y = IMM_den, color = Condition)) +
  geom_beeswarm(cex = 10, priority = "random", size = 7, alpha = 1, corral = "random") +
  geom_boxplot(aes(group = x_pos), fill = NA, width = 1,
               outlier.shape = NA, size = 0.75, color = "black") +
  stat_summary(fun = mean, geom = "point", shape = 15, size = 7, color = "black") +
  geom_segment(data = test_results,
               aes(x = group1_x, xend = group2_x, y = y.position, yend = y.position),
               inherit.aes = FALSE, size = 1, color = "black") +
  geom_text(data = test_results,
            aes(x = (group1_x + group2_x)/2, y = y.position + 0.1, label = p.signif),
            inherit.aes = FALSE, size = 16, fontface = "bold") +
  scale_x_continuous(breaks = c(1, 2.2),
                     labels = c("control", "homeostatic\nscaling")) +
  scale_color_manual(values = c("grey20", "#F7C443")) +
  scale_y_continuous(
    breaks = c(25, 30, 35, 40, 45, 50),
    expand = c(0, 0),
    limits = c(24, 49)
  ) +
  labs(x = "", y = "IMM density (&micro;m<sup>-1</sup>)") +
  theme_classic() +
  theme(
    axis.title.y = element_markdown(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "transparent", color = NA),
    legend.position = "none",
    text = element_text(size = 25, color = "black", face = "bold"),
    axis.text.x = element_text(size = 25, face = "bold", color = "black"),
    axis.text.y = element_text(size = 25, face = "bold", color = "black"),
    axis.ticks = element_line(size = 1, color = "black"),
    axis.line = element_line(size = 0.5, colour = "black")
  )

```
<hr style="border:1px solid white"/>

**Fig 4 E**

```{r}
library(ggplot2)
library(dplyr)
library(rstatix)
library(ggpubr)
library(tidyverse)
library(ggbeeswarm)
library(ggpubr)

# === Read and prepare data ===
Density <- read_csv("./IMM_CM_CJ_k1_density.csv")

# === Normality and test selection ===
if (TRUE) {
  
  # 1. Shapiro-Wilk test for normality per group
  shapiro_results <- Density %>%
    group_by(Condition) %>%
    summarise(
      shapiro_p = shapiro.test(CM_den)$p.value,
      .groups = "drop"
    )
  shapiro_results
  
  # 2. If all groups pass Shapiro -> check variance with Levene
  if (all(shapiro_results$shapiro_p > 0.05)) {
    levene <- leveneTest(CM_den ~ Condition, data = Density, center = median)
    levene
    
    # 3a. Equal variances -> Student’s t-test
    if (levene$`Pr(>F)`[1] > 0.05) {
      stat_res <- t.test(CM_den ~ Condition, data = Density, var.equal = TRUE)
      test_used <- "Student's t-test"
      
    # 3b. Unequal variances -> Welch’s t-test
    } else {
      stat_res <- t.test(CM_den ~ Condition, data = Density, var.equal = FALSE)
      test_used <- "Welch's t-test"
    }
    
  # 4. If any group fails Shapiro -> Wilcoxon rank-sum
  } else {
    stat_res <- wilcox.test(CM_den ~ Condition, data = Density, exact = FALSE)
    test_used <- "Wilcoxon rank-sum test"
  }
  
  # Output
  test_used
  stat_res
}

# === Prepare data for plotting ===
spacing_map <- c("Control" = 1, "TTX" = 2.2)
Density <- Density %>%
  filter(Condition %in% names(spacing_map)) %>%
  mutate(
    x_pos = spacing_map[Condition],
    Condition = factor(Condition, levels = c("Control", "TTX"))
  )

# === Build annotation (stars) ===
pval <- stat_res$p.value
p.signif <- case_when(
  pval < 0.0001 ~ "****",
  pval < 0.001  ~ "***",
  pval < 0.01   ~ "**",
  pval < 0.05   ~ "*",
  TRUE          ~ "ns"
)

test_results <- tibble(
  group1_x = spacing_map["Control"],
  group2_x = spacing_map["TTX"],
  y.position = 30,
  p.signif = p.signif
)

# === Final plot ===
ggplot(Density, aes(x = x_pos, y = CM_den, color = Condition)) +
  geom_beeswarm(cex = 10, priority = "random", size = 7, alpha = 1, corral = "random") +
    geom_boxplot(aes(group = x_pos), fill = NA, width = 1,
               outlier.shape = NA, size = 0.75, color = "black") +
  stat_summary(fun = mean, geom = "point", shape = 15, size = 7, color = "black") +
  geom_segment(data = test_results,
               aes(x = group1_x, xend = group2_x, y = y.position, yend = y.position),
               inherit.aes = FALSE, size = 1, color = "black") +
  geom_text(data = test_results,
            aes(x = (group1_x + group2_x)/2, y = y.position + 0.1, label = p.signif),
            inherit.aes = FALSE, size = 16, fontface = "bold") +
  scale_x_continuous(breaks = c(1, 2.2),
                     labels = c("control", "homeostatic\nscaling")) +
  scale_color_manual(values = c("grey20", "#F7C443")) +
  scale_y_continuous(
    breaks = c(15, 20, 25, 30),
    expand = c(0, 0),
    limits = c(13, 32)
  ) +
  labs(x = "", y = "CM density (&micro;m<sup>-1</sup>)") +
  theme_classic() +
  theme(
    axis.title.y = element_markdown(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "transparent", color = NA),
    legend.position = "none",
    text = element_text(size = 25, color = "black", face = "bold"),
    axis.text.x = element_text(size = 25, face = "bold", color = "black"),
    axis.text.y = element_text(size = 25, face = "bold", color = "black"),
    axis.ticks = element_line(size = 1, color = "black"),
    axis.line = element_line(size = 0.5, colour = "black")
  )

```
<hr style="border:1px solid white"/>

**Fig 4 F**

```{r}
library(ggplot2)
library(dplyr)
library(rstatix)
library(ggpubr)
library(tidyverse)
library(ggbeeswarm)
library(ggpubr)

# === Read and prepare data ===
Density <- read_csv("./IMM_CM_CJ_k1_density.csv") %>%
  mutate(CJ_den = CJ_den/100)

# === Normality and test selection ===
if (TRUE) {
  
  # 1. Shapiro-Wilk test for normality per group
  shapiro_results <- Density %>%
    group_by(Condition) %>%
    summarise(
      shapiro_p = shapiro.test(CJ_den)$p.value,
      .groups = "drop"
    )
  shapiro_results
  
  # 2. If all groups pass Shapiro -> check variance with Levene
  if (all(shapiro_results$shapiro_p > 0.05)) {
    levene <- leveneTest(CJ_den ~ Condition, data = Density, center = median)
    levene
    
    # 3a. Equal variances -> Student’s t-test
    if (levene$`Pr(>F)`[1] > 0.05) {
      stat_res <- t.test(CJ_den ~ Condition, data = Density, var.equal = TRUE)
      test_used <- "Student's t-test"
      
    # 3b. Unequal variances -> Welch’s t-test
    } else {
      stat_res <- t.test(CJ_den ~ Condition, data = Density, var.equal = FALSE)
      test_used <- "Welch's t-test"
    }
    
  # 4. If any group fails Shapiro -> Wilcoxon rank-sum
  } else {
    stat_res <- wilcox.test(CJ_den ~ Condition, data = Density, exact = FALSE)
    test_used <- "Wilcoxon rank-sum test"
  }
  
  # Output
  test_used
  stat_res
}

# === Prepare data for plotting ===
spacing_map <- c("Control" = 1, "TTX" = 2.2)
Density <- Density %>%
  filter(Condition %in% names(spacing_map)) %>%
  mutate(
    x_pos = spacing_map[Condition],
    Condition = factor(Condition, levels = c("Control", "TTX"))
  )

# === Build annotation (stars) ===
pval <- stat_res$p.value
p.signif <- case_when(
  pval < 0.0001 ~ "****",
  pval < 0.001  ~ "***",
  pval < 0.01   ~ "**",
  pval < 0.05   ~ "*",
  TRUE          ~ "ns"
)

test_results <- tibble(
  group1_x = spacing_map["Control"],
  group2_x = spacing_map["TTX"],
  y.position = 22,
  p.signif = p.signif
)

# === Final plot ===
ggplot(Density, aes(x = x_pos, y = CJ_den, color = Condition)) +
  geom_beeswarm(cex = 10, priority = "random", size = 7, alpha = 1, corral = "random") +
  geom_boxplot(aes(group = x_pos), fill = NA, width = 1,
               outlier.shape = NA, size = 0.75, color = "black") +
  stat_summary(fun = mean, geom = "point", shape = 15, size = 7, color = "black") +
  geom_segment(data = test_results,
               aes(x = group1_x, xend = group2_x, y = y.position, yend = y.position),
               inherit.aes = FALSE, size = 1, color = "black") +
  geom_text(data = test_results,
            aes(x = (group1_x + group2_x)/2, y = y.position + 0.1, label = p.signif),
            inherit.aes = FALSE, size = 16, fontface = "bold") +
  scale_x_continuous(breaks = c(1, 2.2),
                     labels = c("control", "homeostatic\nscaling")) +
  scale_color_manual(values = c("grey20", "#4B0082")) +
  scale_y_continuous(
    breaks = c(10, 15, 20),
    expand = c(0, 0),
    limits = c(6, 24)
  ) +
  labs(x = "", y = "cristae junction<br>density x 100 (&micro;m<sup>-3</sup>)") +
  theme_classic() +
  theme(
    axis.title.y = element_markdown(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "transparent", color = NA),
    legend.position = "none",
    text = element_text(size = 25, color = "black", face = "bold"),
    axis.text.x = element_text(size = 25, face = "bold", color = "black"),
    axis.text.y = element_text(size = 25, face = "bold", color = "black"),
    axis.ticks = element_line(size = 1, color = "black"),
    axis.line = element_line(size = 0.5, colour = "black")
  )
```


<hr style="border:1px solid white"/>

**Fig 4 H**

```{r}
library(ggplot2)
library(dplyr)
library(rstatix)
library(ggpubr)
library(tidyverse)
library(ggbeeswarm)
library(ggpubr)

# === Normality and test selection ===
if (TRUE) {
  
  # 1. Shapiro-Wilk test for normality per group
  shapiro_results <- Density %>%
    group_by(Condition) %>%
    summarise(
      shapiro_p = shapiro.test(k1_den)$p.value,
      .groups = "drop"
    )
  shapiro_results
  
  # 2. If all groups pass Shapiro -> check variance with Levene
  if (all(shapiro_results$shapiro_p > 0.05)) {
    levene <- leveneTest(k1_den ~ Condition, data = Density, center = median)
    levene
    
    # 3a. Equal variances -> Student’s t-test
    if (levene$`Pr(>F)`[1] > 0.05) {
      stat_res <- t.test(k1_den ~ Condition, data = Density, var.equal = TRUE)
      test_used <- "Student's t-test"
      
    # 3b. Unequal variances -> Welch’s t-test
    } else {
      stat_res <- t.test(k1_den ~ Condition, data = Density, var.equal = FALSE)
      test_used <- "Welch's t-test"
    }
    
  # 4. If any group fails Shapiro -> Wilcoxon rank-sum
  } else {
    stat_res <- wilcox.test(k1_den ~ Condition, data = Density, exact = FALSE)
    test_used <- "Wilcoxon rank-sum test"
  }
  
  # Output
  test_used
  stat_res
}

# === Prepare data for plotting ===
spacing_map <- c("Control" = 1, "TTX" = 2.2)
Density <- Density %>%
  filter(Condition %in% names(spacing_map)) %>%
  mutate(
    x_pos = spacing_map[Condition],
    Condition = factor(Condition, levels = c("Control", "TTX"))
  )

# === Build annotation (stars) ===
pval <- stat_res$p.value
p.signif <- case_when(
  pval < 0.0001 ~ "****",
  pval < 0.001  ~ "***",
  pval < 0.01   ~ "**",
  pval < 0.05   ~ "*",
  TRUE          ~ "ns"
)

test_results <- tibble(
  group1_x = spacing_map["Control"],
  group2_x = spacing_map["TTX"],
  y.position = 18,
  p.signif = p.signif
)

# === Final plot ===
ggplot(Density, aes(x = x_pos, y = k1_den, color = Condition)) +
  geom_beeswarm(cex = 10, priority = "random", size = 7, alpha = 1, corral = "random") +
  geom_boxplot(aes(group = x_pos), fill = NA, width = 1,
               outlier.shape = NA, size = 0.75, color = "black") +
  stat_summary(fun = mean, geom = "point", shape = 15, size = 7, color = "black") +
  geom_segment(data = test_results,
               aes(x = group1_x, xend = group2_x, y = y.position, yend = y.position),
               inherit.aes = FALSE, size = 1, color = "black") +
  geom_text(data = test_results,
            aes(x = (group1_x + group2_x)/2, y = y.position + 0.1, label = p.signif),
            inherit.aes = FALSE, size = 16, fontface = "bold") +
  scale_x_continuous(breaks = c(1, 2.2),
                     labels = c("control", "homeostatic\nscaling")) +
  scale_color_manual(values = c("grey20", "darkred")) +
  scale_y_continuous(
    breaks = c(6, 9, 12, 15, 18),
    expand = c(0, 0),
    limits = c(5, 19.5)
  ) +
  labs(x = "", y = "high k1 CM<br>density (&micro;m<sup>-1</sup>)") +
  theme_classic() +
  theme(
    axis.title.y = element_markdown(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "transparent", color = NA),
    legend.position = "none",
    text = element_text(size = 30, color = "black", face = "bold"),
    axis.text.x = element_text(size = 30, face = "bold", color = "black"),
    axis.text.y = element_text(size = 30, face = "bold", color = "black"),
    axis.ticks = element_line(size = 1, color = "black"),
    axis.line = element_line(size = 0.5, colour = "black")
  )

```

