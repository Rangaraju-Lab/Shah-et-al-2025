---
title: "Fig S4 A, B, C; pH<sub>mito</sub>, pH<sub>spine</sub> and ATP<sub>spine</sub>"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  html_document:
    theme: darkly
    highlight: breezedark
    df_print: paged
---


```{r setup, include=FALSE}

# Global chunk options: hide messages & warnings everywhere
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  echo = TRUE
)
```

<hr style="border:1px solid white"/>

**Fig S4 A**

**Column Descriptions**

- **Date**: date of imaging or experiment (format: YYYY-MM-DD)  
- **Condition**: experimental condition (e.g., *Control*, *TTX*)  
- **Dish**: dish or coverslip identifier (used for batch tracking)  
- **Cell**: cell identifier within the dish  
- **Mito_ID**: mito roi identifier within the cell 
- **F0**: baseline fluorescence intensity of mito roi before NH₄Cl addition  
- **Fmax**: peak fluorescence intensity of mito roi after NH₄Cl addition corresponding pH of 7.4
- **Mito_pH**: pH of mito roi calculated by Henderson-Hasselbalch equation 

```{r}
# === Libraries ===
library(dplyr)
library(readr)
library(ggplot2)
library(ggbeeswarm)
library(rstatix)
library(car)        # for Levene's test
library(ggtext)     # for element_markdown()

# === Load data (without Dish) ===
pH_df <- read_csv("./Mito pH.csv") %>%
  filter(Condition %in% c("Control", "TTX"))
pH_df %>% arrange(Date, Condition, Dish, Cell, Mito_ID)

# === Animals per condition (check) ===
pH_df %>%
  distinct(Date, Condition) %>%
  count(Condition, name = "n_animal")
# === Cells per condition (check) ===
pH_df %>%
  distinct(Date, Condition, Dish, Cell) %>%
  count(Condition, name = "n_cell")
# === Spines per condition (check) ===
pH_df %>%
  count(Condition, name = "n_mito")

# === Normality and test selection ===
if (TRUE) {
  
  # 1. Shapiro-Wilk test for normality per group
  shapiro_results <- pH_df %>%
    group_by(Condition) %>%
    summarise(
      shapiro_p = shapiro.test(Mito_pH)$p.value,
      .groups = "drop"
    )
  shapiro_results
  
  # 2. If all groups pass Shapiro -> check variance with Levene
  if (all(shapiro_results$shapiro_p > 0.05)) {
    levene <- leveneTest(Mito_pH ~ Condition, data = pH_df, center = median)
    levene
    
    # 3a. Equal variances -> Student’s t-test
    if (levene$`Pr(>F)`[1] > 0.05) {
      stat_res <- t.test(Mito_pH ~ Condition, data = pH_df, var.equal = TRUE)
      test_used <- "Student's t-test"
      
    # 3b. Unequal variances -> Welch’s t-test
    } else {
      stat_res <- t.test(Mito_pH ~ Condition, data = pH_df, var.equal = FALSE)
      test_used <- "Welch's t-test"
    }
    
  # 4. If any group fails Shapiro -> Wilcoxon rank-sum
  } else {
    stat_res <- wilcox.test(Mito_pH ~ Condition, data = pH_df, exact = FALSE)
    test_used <- "Wilcoxon rank-sum test"
  }
  
  # Output
  test_used
  stat_res
}

# === Prepare data for plotting ===
spacing_map <- c("Control" = 1, "TTX" = 2.2)
pH_df <- pH_df %>%
  filter(Condition %in% names(spacing_map)) %>%
  mutate(
    x_pos = spacing_map[Condition],
    Condition = factor(Condition, levels = c("Control", "TTX"))
  )

# === Build annotation (stars) ===
pval <- stat_res$p.value
p.signif <- case_when(
  pval < 0.0001 ~ "****",
  pval < 0.001  ~ "***",
  pval < 0.01   ~ "**",
  pval < 0.05   ~ "*",
  TRUE          ~ "ns"
)

test_results <- tibble(
  group1_x = spacing_map["Control"],
  group2_x = spacing_map["TTX"],
  y.position = 7.45,
  p.signif = p.signif
)

# === Final plot ===
ggplot(pH_df, aes(x = x_pos, y = Mito_pH, color = Condition)) +
  geom_boxplot(aes(group = x_pos), fill = NA, width = 1,
               outlier.shape = NA, size = 0.75, color = "black") +
  geom_beeswarm(cex = 5, priority = "random", size = 5, alpha = 0.8, corral = "random") +
  stat_summary(fun = mean, geom = "point", shape = 15, size = 5, color = "black") +
  geom_segment(data = test_results,
               aes(x = group1_x, xend = group2_x, y = y.position, yend = y.position),
               inherit.aes = FALSE, size = 1, color = "black") +
  geom_text(data = test_results,
            aes(x = (group1_x + group2_x)/2, y = y.position + 0.1, label = p.signif),
            inherit.aes = FALSE, size = 16, fontface = "bold") +
  scale_x_continuous(breaks = c(1, 2.2),
                     labels = c("control", "homeostatic\nscaling")) +
  scale_color_manual(values = c("grey20", "#006400")) +
  scale_y_continuous(
    breaks = c(6.3, 6.5, 6.7, 6.9, 7.1, 7.3, 7.5),
    expand = c(0, 0)
  ) +
  coord_cartesian(ylim = c(6.7, 7.6)) +
  labs(x = "", y = "pH<sub>mito</sub>") +
  theme_classic() +
  theme(
    axis.title.y = element_markdown(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "transparent", color = NA),
    legend.position = "none",
    text = element_text(size = 30, color = "black", face = "bold"),
    axis.text.x = element_text(size = 30, face = "bold", color = "black"),
    axis.text.y = element_text(size = 30, face = "bold", color = "black"),
    axis.ticks = element_line(size = 1, color = "black"),
    axis.line = element_line(size = 0.5, colour = "black")
  )
```
<hr style="border:1px solid white"/>

**Fig S4 B**

**Column Descriptions**

- **Date**: date of imaging or experiment (format: YYYY-MM-DD)  
- **Condition**: experimental condition (e.g., *Control*, *TTX*)  
- **Dish**: dish or coverslip identifier (used for batch tracking)  
- **Cell**: cell identifier within the dish
- **Spine_ID**: spine identifier within the cell 
- **F0**: baseline fluorescence intensity of spine before NH₄Cl addition  
- **Fmax**: peak fluorescence intensity of spine after NH₄Cl addition corresponding pH of 7.4
- **Spine_pH**: pH of spine calculated by Henderson-Hasselbalch equation 

```{r}
# === Libraries ===
library(dplyr)
library(readr)
library(ggplot2)
library(ggbeeswarm)
library(rstatix)
library(car)        # for Levene's test
library(ggtext)     # for element_markdown()

# === Load data (without Dish) ===
pH_df <- read_csv("./Spine pH.csv") %>%
  filter(Condition %in% c("Control", "TTX"))
pH_df %>% arrange(Date, Condition, Dish, Cell, Spine_ID)

# === Animals per condition (check) ===
pH_df %>%
  distinct(Date, Condition) %>%
  count(Condition, name = "n_animal")
# === Cells per condition (check) ===
pH_df %>%
  distinct(Date, Condition, Dish, Cell) %>%
  count(Condition, name = "n_cell")
# === Spines per condition (check) ===
pH_df %>%
  count(Condition, name = "n_spines")

# === Normality and test selection ===
if (TRUE) {
  
  # 1. Shapiro-Wilk test for normality per group
  shapiro_results <- pH_df %>%
    group_by(Condition) %>%
    summarise(
      shapiro_p = shapiro.test(Spine_pH)$p.value,
      .groups = "drop"
    )
  shapiro_results
  
  # 2. If all groups pass Shapiro -> check variance with Levene
  if (all(shapiro_results$shapiro_p > 0.05)) {
    levene <- leveneTest(Spine_pH ~ Condition, data = pH_df, center = median)
    levene
    
    # 3a. Equal variances -> Student’s t-test
    if (levene$`Pr(>F)`[1] > 0.05) {
      stat_res <- t.test(Spine_pH ~ Condition, data = pH_df, var.equal = TRUE)
      test_used <- "Student's t-test"
      
    # 3b. Unequal variances -> Welch’s t-test
    } else {
      stat_res <- t.test(Spine_pH ~ Condition, data = pH_df, var.equal = FALSE)
      test_used <- "Welch's t-test"
    }
    
  # 4. If any group fails Shapiro -> Wilcoxon rank-sum
  } else {
    stat_res <- wilcox.test(Spine_pH ~ Condition, data = pH_df, exact = FALSE)
    test_used <- "Wilcoxon rank-sum test"
  }
  
  # Output
  test_used
  stat_res
}

# === Prepare data for plotting ===
spacing_map <- c("Control" = 1, "TTX" = 2.2)
pH_df <- pH_df %>%
  filter(Condition %in% names(spacing_map)) %>%
  mutate(
    x_pos = spacing_map[Condition],
    Condition = factor(Condition, levels = c("Control", "TTX"))
  )

# === Build annotation (stars) ===
pval <- stat_res$p.value
p.signif <- case_when(
  pval < 0.0001 ~ "****",
  pval < 0.001  ~ "***",
  pval < 0.01   ~ "**",
  pval < 0.05   ~ "*",
  TRUE          ~ "ns"
)

test_results <- tibble(
  group1_x = spacing_map["Control"],
  group2_x = spacing_map["TTX"],
  y.position = 7.45,
  p.signif = p.signif
)

# === Final plot ===
ggplot(pH_df, aes(x = x_pos, y = Spine_pH, color = Condition)) +
  geom_boxplot(aes(group = x_pos), fill = NA, width = 1,
               outlier.shape = NA, size = 0.75, color = "black") +
  geom_beeswarm(cex = 5, priority = "random", size = 5, alpha = 0.8, corral = "random") +
  stat_summary(fun = mean, geom = "point", shape = 15, size = 5, color = "black") +
  geom_segment(data = test_results,
               aes(x = group1_x, xend = group2_x, y = y.position, yend = y.position),
               inherit.aes = FALSE, size = 1, color = "black") +
  geom_text(data = test_results,
            aes(x = (group1_x + group2_x)/2, y = y.position + 0.005, label = p.signif),
            inherit.aes = FALSE, size = 16, fontface = "bold") +
  scale_x_continuous(breaks = c(1, 2.2),
                     labels = c("control", "homeostatic\nscaling")) +
  scale_color_manual(values = c("grey20", "#006400")) +
  scale_y_continuous(
    breaks = c(6.3, 6.5, 6.7, 6.9, 7.1, 7.3, 7.5),
    expand = c(0, 0)
  ) +
  coord_cartesian(ylim = c(6.15, 7.55)) +
  labs(x = "", y = "pH<sub>spine</sub>") +
  theme_classic() +
  theme(
    axis.title.y = element_markdown(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "transparent", color = NA),
    legend.position = "none",
    text = element_text(size = 30, color = "black", face = "bold"),
    axis.text.x = element_text(size = 30, face = "bold", color = "black"),
    axis.text.y = element_text(size = 30, face = "bold", color = "black"),
    axis.ticks = element_line(size = 1, color = "black"),
    axis.line = element_line(size = 0.5, colour = "black")
  )

```
<hr style="border:1px solid white"/>

**Fig S4 C**

**Column Descriptions**
- **Date**: Date of imaging or experiment (format: YYYY-MM-DD)  
- **Condition**: Experimental condition (e.g., *Control*, *TTXinTTX*)  
- **Dish**: Dish or coverslip identifier (used for batch tracking)  
- **Cell**: Cell identifier within the dish  
- **L**: Luminescence intensity of spine  
- **F**: Fluorescence intensity of spine  
- **LbyF**: Luminescence normalized by Fluorescence  

```{r}
# === Libraries ===
library(dplyr)
library(readr)
library(ggplot2)
library(ggbeeswarm)
library(rstatix)
library(car)        # for Levene's test
library(ggtext)     # for element_markdown()

# === Load data (without Dish) ===
LbyF_df <- read_csv("./Spine LbyF.csv") %>%
  dplyr::select(Date, Condition, Dish, Cell, L, F, LbyF) %>%
  filter(Condition %in% c("Control", "TTXinTTX"))
LbyF_df %>% arrange(Date, Condition, Dish, Cell)

# === Animals per condition (check) ===
LbyF_df %>%
  distinct(Date, Condition) %>%
  count(Condition, name = "n_animal")
# === Cells per condition (check) ===
LbyF_df %>%
  distinct(Date, Condition, Dish, Cell) %>%
  count(Condition, name = "n_cell")
# === Spines per condition (check) ===
LbyF_df %>%
  count(Condition, name = "n_spines")

# === Normality and test selection ===
if (TRUE) {
  
  # 1. Shapiro-Wilk test for normality per group
  shapiro_results <- LbyF_df %>%
    group_by(Condition) %>%
    summarise(
      shapiro_p = shapiro.test(LbyF)$p.value,
      .groups = "drop"
    )
  shapiro_results
  
  # 2. If all groups pass Shapiro -> check variance with Levene
  if (all(shapiro_results$shapiro_p > 0.05)) {
    levene <- leveneTest(LbyF ~ Condition, data = LbyF_df, center = median)
    levene
    
    # 3a. Equal variances -> Student’s t-test
    if (levene$`Pr(>F)`[1] > 0.05) {
      stat_res <- t.test(LbyF ~ Condition, data = LbyF_df, var.equal = TRUE)
      test_used <- "Student's t-test"
      
    # 3b. Unequal variances -> Welch’s t-test
    } else {
      stat_res <- t.test(LbyF ~ Condition, data = LbyF_df, var.equal = FALSE)
      test_used <- "Welch's t-test"
    }
    
  # 4. If any group fails Shapiro -> Wilcoxon rank-sum
  } else {
    stat_res <- wilcox.test(LbyF ~ Condition, data = LbyF_df, exact = FALSE)
    test_used <- "Wilcoxon rank-sum test"
  }
  
  # Output
  test_used
  stat_res
}

# === Prepare data for plotting ===
spacing_map <- c("Control" = 1, "TTXinTTX" = 2.2)
LbyF_df <- LbyF_df %>%
  filter(Condition %in% names(spacing_map)) %>%
  mutate(
    x_pos = spacing_map[Condition],
    Condition = factor(Condition, levels = c("Control", "TTXinTTX"))
  )

# === Build annotation (stars) ===
pval <- stat_res$p.value
p.signif <- case_when(
  pval < 0.0001 ~ "****",
  pval < 0.001  ~ "***",
  pval < 0.01   ~ "**",
  pval < 0.05   ~ "*",
  TRUE          ~ "ns"
)

test_results <- tibble(
  group1_x = spacing_map["Control"],
  group2_x = spacing_map["TTXinTTX"],
  y.position = 0.7,
  p.signif = p.signif
)

# === Final plot ===
ggplot(LbyF_df, aes(x = x_pos, y = LbyF, color = Condition)) +
  geom_boxplot(aes(group = x_pos), fill = NA, width = 1,
               outlier.shape = NA, size = 0.75, color = "black") +
  geom_beeswarm(cex = 3, priority = "random", size = 3, alpha = 0.8, corral = "random") +
  stat_summary(fun = mean, geom = "point", shape = 15, size = 5, color = "black") +
  geom_segment(data = test_results,
               aes(x = group1_x, xend = group2_x, y = y.position, yend = y.position),
               inherit.aes = FALSE, size = 1, color = "black") +
  geom_text(data = test_results,
            aes(x = (group1_x + group2_x)/2, y = y.position + 0.005, label = p.signif),
            inherit.aes = FALSE, size = 16, fontface = "bold") +
  scale_x_continuous(breaks = c(1, 2.2),
                     labels = c("control", "homeostatic\nscaling\n(in TTX)")) +
  scale_color_manual(values = c("grey20", "#8A00CB")) +
  scale_y_continuous(
    breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1.0, 1.2, 1.4),
    expand = c(0, 0)
  ) +
  coord_cartesian(ylim = c(0, 0.75)) +
  labs(x = "", y = "ATP<sub>spine</sub> (L/F)") +
  theme_classic() +
  theme(
    axis.title.y = element_markdown(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "transparent", color = NA),
    legend.position = "none",
    text = element_text(size = 30, color = "black", face = "bold"),
    axis.text.x = element_text(size = 30, face = "bold", color = "black"),
    axis.text.y = element_text(size = 30, face = "bold", color = "black"),
    axis.ticks = element_line(size = 1, color = "black"),
    axis.line = element_line(size = 0.5, colour = "black")
  )

```

