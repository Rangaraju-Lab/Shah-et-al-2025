---
title: "Fig 5 D; ATP synthase copies per cluster"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  html_document:
    theme: darkly
    highlight: breezedark
    df_print: paged
---


```{r setup, include=FALSE}

# Global chunk options: hide messages & warnings everywhere
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

<hr style="border:1px solid white"/>

**Fig 6 D (top)**

**Column Descriptions**

- **Date**: date of imaging or experiment (format: YYYY-MM-DD)  
- **Condition**: experimental condition (*Control*, *TTX*)  
- **mito_id**: mito roi identifier within the condition 
- **area_um2**: area of mito roi in µm²
- **copy number**: copies of ATP synthase per cluster
- **total_copies**: total copies of ATP synthase in mito_id normalized by area_um2
- **bin**: copies per cluster size bins for histogram (*1-4*, *5-8*, *9-12*, *13-24*)


```{r}
# === Libraries ===
library(dplyr)
library(readr)
library(ggplot2)
library(ggbeeswarm)
library(rstatix)
library(car)        # for Levene's test
library(ggtext)     # for element_markdown()
library(jsonlite)
library(ggpubr)
library(tidyverse)

# === Read and prepare data ===
OSCP <- read_csv("./ATP_synthase_clusters.csv") %>%
  mutate(bin = factor(bin, levels = c("1-4", "5-8", "9-12", "13-24")))

OSCP %>% arrange(Date, Condition, mito_id)

# === Animals per condition (check) ===
OSCP %>%
  distinct(Date, Condition) %>%
  count(Condition, name = "n_animal")
# === Clusters per condition (check) ===
OSCP %>%
  count(Condition, name = "n_clusters")


# === Normality and test selection ===
if (TRUE) {
  
  # 1. Shapiro-Wilk test for normality per group
  shapiro_results <- OSCP %>%
    group_by(Condition) %>%
    summarise(
      shapiro_p = shapiro.test(total_copies )$p.value,
      .groups = "drop"
    )
  shapiro_results
  
  # 2. If all groups pass Shapiro -> check variance with Levene
  if (all(shapiro_results$shapiro_p > 0.05)) {
    levene <- leveneTest(total_copies  ~ Condition, data = OSCP, center = median)
    levene
    
    # 3a. Equal variances -> Student’s t-test
    if (levene$`Pr(>F)`[1] > 0.05) {
      stat_res <- t.test(total_copies  ~ Condition, data = OSCP, var.equal = TRUE)
      test_used <- "Student's t-test"
      
    # 3b. Unequal variances -> Welch’s t-test
    } else {
      stat_res <- t.test(total_copies  ~ Condition, data = OSCP, var.equal = FALSE)
      test_used <- "Welch's t-test"
    }
    
  # 4. If any group fails Shapiro -> Wilcoxon rank-sum
  } else {
    stat_res <- wilcox.test(total_copies  ~ Condition, data = OSCP, exact = FALSE)
    test_used <- "Wilcoxon rank-sum test"
  }
  
  # Output
  test_used
  stat_res
}

# === Wilcoxon test per bin ===
pvals <- OSCP %>%
  group_by(bin) %>%
  summarise(
    p = tryCatch(
      suppressWarnings(wilcox.test(total_copies ~ Condition)$p.value),
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    group1 = "Control",
    group2 = "TTX",
    y.position = 1000,
    p.adj.signif = case_when(
      is.na(p) ~ "",
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE ~ "ns"
    ),
    bin_numeric = as.numeric(bin)
  ) %>%
  filter(p.adj.signif != "ns" & p.adj.signif != "")  

pvals
ggplot(OSCP, aes(x = bin, y = total_copies)) +
  geom_beeswarm(
    aes(color = Condition),
    cex = 0.5,
    priority = "random",
    size = 1,
    shape = 16,
    dodge.width = 0.9,
    alpha = 0.8,
    corral = "random"
  ) +
    # === Bar with mean ± SEM instead of boxplot ===
  stat_summary(
    aes(group = interaction(bin, Condition), fill = Condition),
    fun = mean,
    geom = "bar",
    position = position_dodge(width = 0.9),
    width = 0.8,
    color = "black",
    alpha = 0.2   # << transparency here
  ) +
  stat_summary(
    aes(group = interaction(bin, Condition)),
    fun.data = mean_se,   # mean ± SEM
    geom = "errorbar",
    position = position_dodge(width = 0.9),
    width = 0.2,
    size = 1
  ) +
  # Only draw bars for bins with significant stars
  geom_segment(
    data = pvals,
    aes(
      x = bin_numeric - 0.2,
      xend = bin_numeric + 0.2,
      y = y.position - 0.3 * y.position,
      yend = y.position - 0.3 * y.position
    ),
    inherit.aes = FALSE,
    size = 1,
    color = "black"
  ) +
  # Add stars
  geom_text(
    data = pvals,
    aes(
      x = bin_numeric,
      y = y.position,
      label = p.adj.signif
    ),
    size = 16,
    fontface = "bold",
    inherit.aes = FALSE
  ) +
  scale_y_log10(
    limits = c(1, 1500),
    breaks = c(1, 10, 100, 1000),
    labels = scales::comma_format(),
    expand = c(0, 0)
  ) +
  scale_color_manual(values = c("Control" = "grey20", "TTX" = "#0065F8")) +
  scale_fill_manual(values = c("Control" = "grey20", "TTX" = "#0065F8")) +
  labs(
    x = "copy number per cluster",
    y = "ATP synthase copies (&micro;m<sup>-2</sup>)",
    color = NULL,
    fill = NULL
  ) +
  theme_classic() +
  theme(
    axis.title.y = element_markdown(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "transparent", color = NA),
    legend.position = "none",
    text = element_text(size = 20, color = "black", face = "bold"),
    axis.text.x = element_text(size = 20, face = "bold", color = "black"),
    axis.text.y = element_text(size = 20, face = "bold", color = "black"),
    axis.ticks = element_line(size = 1, color = "black"),
    axis.line = element_line(size = 0.5, colour = "black")
  )
```