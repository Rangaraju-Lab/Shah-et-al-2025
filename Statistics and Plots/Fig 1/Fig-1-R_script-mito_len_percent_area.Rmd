---
title: "Fig 1 C, D, E; mito length, % spines with mito, local mito area"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  html_document:
    theme: darkly
    highlight: breezedark
    df_print: paged
---


```{r setup, include=FALSE}

# Global chunk options: hide messages & warnings everywhere
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

<hr style="border:1px solid white"/>

**Column Descriptions**

- **Date**: date of imaging or experiment (format: YYYY-MM-DD)  
- **Condition**: experimental condition (*Control*, *TTX*)  
- **Cell**: cell identifier within condition 
- **mean_mito_len**: average length (in µm)of mito compartment in the cell
- **n_spines**: total number of spines in cell
- **mito_spines**: number of spines with mito within 1 µm radius under spine
- **mito_percent**: percentage of spines with mito under them
- **mean_psd95**: average area (in µm²) of spine in the cell 
- **mean_mito**: average area (in µm²) of mito within 1 µm radius under spine 

<hr style="border:1px solid white"/>

**Fig 1 C**
```{r}
# === Libraries ===
library(dplyr)
library(readr)
library(ggplot2)
library(ggbeeswarm)
library(rstatix)
library(car)        # for Levene's test
library(ggtext)     # for element_markdown()
library(ggbreak)

# === Read and prepare data ===
mito_df <- read_csv("./mito_len_percent_area.csv")
mito_df %>% arrange(Date, Condition, Cell)
# === Animals per condition (check) ===
mito_df %>%
  distinct(Date, Condition) %>%
  count(Condition, name = "n_animal")
# === Cells per condition (check) ===
mito_df %>%
  distinct(Date, Condition, Cell) %>%
  count(Condition, name = "n_cell")

# === Normality and test selection ===
if (TRUE) {
  
  # 1. Shapiro-Wilk test for normality per group
  shapiro_results <- mito_df %>%
    group_by(Condition) %>%
    summarise(
      shapiro_p = shapiro.test(mean_mito_len)$p.value,
      .groups = "drop"
    )
  shapiro_results
  
  # 2. If all groups pass Shapiro -> check variance with Levene
  if (all(shapiro_results$shapiro_p > 0.05)) {
    levene <- leveneTest(mean_mito_len ~ Condition, data = mito_df, center = median)
    levene
    
    # 3a. Equal variances -> Student’s t-test
    if (levene$`Pr(>F)`[1] > 0.05) {
      stat_res <- t.test(mean_mito_len ~ Condition, data = mito_df, var.equal = TRUE)
      test_used <- "Student's t-test"
      
    # 3b. Unequal variances -> Welch’s t-test
    } else {
      stat_res <- t.test(mean_mito_len ~ Condition, data = mito_df, var.equal = FALSE)
      test_used <- "Welch's t-test"
    }
    
  # 4. If any group fails Shapiro -> Wilcoxon rank-sum
  } else {
    stat_res <- wilcox.test(mean_mito_len ~ Condition, data = mito_df, exact = FALSE)
    test_used <- "Wilcoxon rank-sum test"
  }
  
  # Output
  test_used
  stat_res
}


# === Prepare data for plotting ===
spacing_map <- c("Control" = 1, "TTX" = 2.2)
mito_df <- mito_df %>%
  filter(Condition %in% names(spacing_map)) %>%
  mutate(
    x_pos = spacing_map[Condition],
    Condition = factor(Condition, levels = c("Control", "TTX"))
  )

# === Build annotation (stars) ===
pval <- stat_res$p.value
p.signif <- case_when(
  pval < 0.0001 ~ "****",
  pval < 0.001  ~ "***",
  pval < 0.01   ~ "**",
  pval < 0.05   ~ "*",
  TRUE          ~ "ns"
)

test_results <- tibble(
  group1_x = spacing_map["Control"],
  group2_x = spacing_map["TTX"],
  y.position = 50,
  p.signif = p.signif
)

# === Final plot ===
ggplot(mito_df, aes(x = x_pos, y = mean_mito_len, color = Condition)) +
  geom_beeswarm(cex = 5, priority = "random", size = 5, alpha = 0.8, corral = "random") +
  geom_boxplot(aes(group = x_pos), fill = NA, width = 1,
               outlier.shape = NA, size = 0.75, color = "black") +
  stat_summary(fun = mean, geom = "point", shape = 15, size = 5, color = "black") +
  geom_segment(data = test_results,
               aes(x = group1_x, xend = group2_x, y = y.position, yend = y.position),
               inherit.aes = FALSE, size = 1, color = "black") +
  geom_text(data = test_results,
            aes(x = (group1_x + group2_x)/2, y = y.position + 2, label = p.signif),
            inherit.aes = FALSE, size = 16, fontface = "bold") +
  scale_x_continuous(breaks = c(1, 2.2),
                     labels = c("control", "homeostatic\nscaling")) +
  scale_color_manual(values = c("grey20", "#00B400")) +
  scale_y_continuous(
    breaks = c(0, 10, 20, 50),
    expand = c(0, 0),
    limits = c(-1, 55)
  ) +
  scale_y_break(c(28, 46)) +# Gap between 30–40
  labs(x = "", y = "mitochondrial length (&micro;m)") +
  theme_classic() +
  theme(
    axis.title.y = element_markdown(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "transparent", color = NA),
    legend.position = "none",
    text = element_text(size = 25, color = "black", face = "bold"),
    axis.text.x = element_text(size = 25, face = "bold", color = "black"),
    axis.text.y = element_text(size = 25, face = "bold", color = "black"),
    axis.ticks = element_line(size = 1, color = "black"),
    axis.line = element_line(size = 0.5, colour = "black"),
    axis.text.y.right  = element_blank(),
    axis.ticks.y.right = element_blank(),
    axis.line.y.right  = element_blank(),
    axis.title.y.right = element_blank()
  )

```
<hr style="border:1px solid white"/>

**Fig 1 D**
```{r}
# === Read and prepare data ===
mito_df <- read_csv("./mito_len_percent_area.csv")

# === Normality and test selection ===
if (TRUE) {
  
  # 1. Shapiro-Wilk test for normality per group
  shapiro_results <- mito_df %>%
    group_by(Condition) %>%
    summarise(
      shapiro_p = shapiro.test(mito_percent)$p.value,
      .groups = "drop"
    )
  shapiro_results
  
  # 2. If all groups pass Shapiro -> check variance with Levene
  if (all(shapiro_results$shapiro_p > 0.05)) {
    levene <- leveneTest(mito_percent ~ Condition, data = mito_df, center = median)
    levene
    
    # 3a. Equal variances -> Student’s t-test
    if (levene$`Pr(>F)`[1] > 0.05) {
      stat_res <- t.test(mito_percent ~ Condition, data = mito_df, var.equal = TRUE)
      test_used <- "Student's t-test"
      
    # 3b. Unequal variances -> Welch’s t-test
    } else {
      stat_res <- t.test(mito_percent ~ Condition, data = mito_df, var.equal = FALSE)
      test_used <- "Welch's t-test"
    }
    
  # 4. If any group fails Shapiro -> Wilcoxon rank-sum
  } else {
    stat_res <- wilcox.test(mito_percent ~ Condition, data = mito_df, exact = FALSE)
    test_used <- "Wilcoxon rank-sum test"
  }
  
  # Output
  test_used
  stat_res
}


# === Prepare data for plotting ===
spacing_map <- c("Control" = 1, "TTX" = 2.2)
mito_df <- mito_df %>%
  filter(Condition %in% names(spacing_map)) %>%
  mutate(
    x_pos = spacing_map[Condition],
    Condition = factor(Condition, levels = c("Control", "TTX"))
  )

# === Build annotation (stars) ===
pval <- stat_res$p.value
p.signif <- case_when(
  pval < 0.0001 ~ "****",
  pval < 0.001  ~ "***",
  pval < 0.01   ~ "**",
  pval < 0.05   ~ "*",
  TRUE          ~ "ns"
)

test_results <- tibble(
  group1_x = spacing_map["Control"],
  group2_x = spacing_map["TTX"],
  y.position = 105,
  p.signif = p.signif
)

# === Final plot ===
ggplot(mito_df, aes(x = x_pos, y = mito_percent, color = Condition)) +
  geom_beeswarm(cex = 5, priority = "random", size = 5, alpha = 0.8, corral = "random") +
  geom_boxplot(aes(group = x_pos), fill = NA, width = 1,
               outlier.shape = NA, size = 0.75, color = "black") +
  stat_summary(fun = mean, geom = "point", shape = 15, size = 5, color = "black") +
  geom_segment(data = test_results,
               aes(x = group1_x, xend = group2_x, y = y.position, yend = y.position),
               inherit.aes = FALSE, size = 1, color = "black") +
  geom_text(data = test_results,
            aes(x = (group1_x + group2_x)/2, y = y.position + 2, label = p.signif),
            inherit.aes = FALSE, size = 16, fontface = "bold") +
  scale_x_continuous(breaks = c(1, 2.2),
                     labels = c("control", "homeostatic\nscaling")) +
  scale_color_manual(values = c("grey20", "#00B400")) +
  scale_y_continuous(
    breaks = c(40, 60, 80, 100),
    expand = c(0, 0),
    limits = c(30, 115)
  ) +
  labs(x = "", y = "% spines with mito") +
  theme_classic() +
  theme(
    axis.title.y = element_markdown(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "transparent", color = NA),
    legend.position = "none",
    text = element_text(size = 25, color = "black", face = "bold"),
    axis.text.x = element_text(size = 25, face = "bold", color = "black"),
    axis.text.y = element_text(size = 25, face = "bold", color = "black"),
    axis.ticks = element_line(size = 1, color = "black"),
    axis.line = element_line(size = 0.5, colour = "black")
  )

```
<hr style="border:1px solid white"/>

**Fig 1 E**
```{r}
# === Read and prepare data ===
mito_df <- read_csv("./mito_len_percent_area.csv")

# === Normality and test selection ===
if (TRUE) {
  
  # 1. Shapiro-Wilk test for normality per group
  shapiro_results <- mito_df %>%
    group_by(Condition) %>%
    summarise(
      shapiro_p = shapiro.test(mean_mito)$p.value,
      .groups = "drop"
    )
  shapiro_results
  
  # 2. If all groups pass Shapiro -> check variance with Levene
  if (all(shapiro_results$shapiro_p > 0.05)) {
    levene <- leveneTest(mean_mito ~ Condition, data = mito_df, center = median)
    levene
    
    # 3a. Equal variances -> Student’s t-test
    if (levene$`Pr(>F)`[1] > 0.05) {
      stat_res <- t.test(mean_mito ~ Condition, data = mito_df, var.equal = TRUE)
      test_used <- "Student's t-test"
      
    # 3b. Unequal variances -> Welch’s t-test
    } else {
      stat_res <- t.test(mean_mito ~ Condition, data = mito_df, var.equal = FALSE)
      test_used <- "Welch's t-test"
    }
    
  # 4. If any group fails Shapiro -> Wilcoxon rank-sum
  } else {
    stat_res <- wilcox.test(mean_mito ~ Condition, data = mito_df, exact = FALSE)
    test_used <- "Wilcoxon rank-sum test"
  }
  
  # Output
  test_used
  stat_res
}


# === Prepare data for plotting ===
spacing_map <- c("Control" = 1, "TTX" = 2.2)
mito_df <- mito_df %>%
  filter(Condition %in% names(spacing_map)) %>%
  mutate(
    x_pos = spacing_map[Condition],
    Condition = factor(Condition, levels = c("Control", "TTX"))
  )

# === Build annotation (stars) ===
pval <- stat_res$p.value
p.signif <- case_when(
  pval < 0.0001 ~ "****",
  pval < 0.001  ~ "***",
  pval < 0.01   ~ "**",
  pval < 0.05   ~ "*",
  TRUE          ~ "ns"
)

test_results <- tibble(
  group1_x = spacing_map["Control"],
  group2_x = spacing_map["TTX"],
  y.position = 1.65,
  p.signif = p.signif
)

# === Final plot ===
ggplot(mito_df, aes(x = x_pos, y = mean_mito, color = Condition)) +
  geom_beeswarm(cex = 5, priority = "random", size = 5, alpha = 0.8, corral = "random") +
  geom_boxplot(aes(group = x_pos), fill = NA, width = 1,
               outlier.shape = NA, size = 0.75, color = "black") +
  stat_summary(fun = mean, geom = "point", shape = 15, size = 5, color = "black") +
  geom_segment(data = test_results,
               aes(x = group1_x, xend = group2_x, y = y.position, yend = y.position),
               inherit.aes = FALSE, size = 1, color = "black") +
  geom_text(data = test_results,
            aes(x = (group1_x + group2_x)/2, y = y.position + 0.05, label = p.signif),
            inherit.aes = FALSE, size = 16, fontface = "bold") +
  scale_x_continuous(breaks = c(1, 2.2),
                     labels = c("control", "homeostatic\nscaling")) +
  scale_color_manual(values = c("grey20", "#00B400")) +
  scale_y_continuous(
    breaks = c(0.6, 0.8, 1.0, 1.2, 1.4, 1.6),
    expand = c(0, 0),
    limits = c(0.55, 1.79)
  ) +
  labs(x = "", y = "local mito area (&micro;m<sup>2</sup>)") +
  theme_classic() +
  theme(
    axis.title.y = element_markdown(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "transparent", color = NA),
    legend.position = "none",
    text = element_text(size = 25, color = "black", face = "bold"),
    axis.text.x = element_text(size = 25, face = "bold", color = "black"),
    axis.text.y = element_text(size = 25, face = "bold", color = "black"),
    axis.ticks = element_line(size = 1, color = "black"),
    axis.line = element_line(size = 0.5, colour = "black")
  )

```