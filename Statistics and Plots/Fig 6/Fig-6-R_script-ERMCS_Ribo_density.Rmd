---
title: "Fig 6 D, E, F; ERMCS, ER, ribosome density, ribosome cluster to OMM distance"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  html_document:
    theme: darkly
    highlight: breezedark
    df_print: paged
---


```{r setup, include=FALSE}

# Global chunk options: hide messages & warnings everywhere
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

<hr style="border:1px solid white"/>

**Fig 6 D (top)**

**Column Descriptions**

- **Condition**: experimental condition (e.g., *Control*, *TTX*)  
- **Mito_ID**: mito roi identifier within the condition 
- **ER_sa**: volume of mito within the EM section (volume of outer mito membrane mesh)
- **ERMCS20_sa**: surface area of ER mesh within 20 nm of outer mito membrane mesh
- **ER_den**: ER_sa / hull_diameter
- **ERMCS_den**: ERMCS20_sa / ER_sa
- **Total_Ribosomes**: total number of ribosomes in or near clusters within tomogram (rows with NA represent tomograms with no ribosomes observed)
- **Ribo_den**: Total_Ribosomes / hull_diameter
- **hull_diameter**: convex hull diameter ~ mito length ~ dendrite length (length of outer mito membrane mesh) in µm
- **bounding_thickness**: thickness of the tomogram ~ thickness EM section in µm


```{r}
# === Libraries ===
library(dplyr)
library(readr)
library(ggplot2)
library(ggbeeswarm)
library(rstatix)
library(car)        # for Levene's test
library(ggtext)     # for element_markdown()

# === Read and prepare data ===
Density <- read_csv("./ERMCS_Ribo_density.csv")
Density %>% arrange(Condition, Dish, Cell, Mito_ID)

# === Mito per condition (check) ===
Density %>%
  count(Condition, name = "n_mito")


# === Normality and test selection ===
if (TRUE) {
  
  # 1. Shapiro-Wilk test for normality per group
  shapiro_results <- Density %>%
    group_by(Condition) %>%
    summarise(
      shapiro_p = shapiro.test(ERMCS_den)$p.value,
      .groups = "drop"
    )
  shapiro_results
  
  # 2. If all groups pass Shapiro -> check variance with Levene
  if (all(shapiro_results$shapiro_p > 0.05)) {
    levene <- leveneTest(ERMCS_den ~ Condition, data = Density, center = median)
    levene
    
    # 3a. Equal variances -> Student’s t-test
    if (levene$`Pr(>F)`[1] > 0.05) {
      stat_res <- t.test(ERMCS_den ~ Condition, data = Density, var.equal = TRUE)
      test_used <- "Student's t-test"
      
    # 3b. Unequal variances -> Welch’s t-test
    } else {
      stat_res <- t.test(ERMCS_den ~ Condition, data = Density, var.equal = FALSE)
      test_used <- "Welch's t-test"
    }
    
  # 4. If any group fails Shapiro -> Wilcoxon rank-sum
  } else {
    stat_res <- wilcox.test(ERMCS_den ~ Condition, data = Density, exact = FALSE)
    test_used <- "Wilcoxon rank-sum test"
  }
  
  # Output
  test_used
  stat_res
}

# === Prepare data for plotting ===
spacing_map <- c("Control" = 1, "TTX" = 2.2)
Density <- Density %>%
  filter(Condition %in% names(spacing_map)) %>%
  mutate(
    x_pos = spacing_map[Condition],
    Condition = factor(Condition, levels = c("Control", "TTX"))
  )

# === Build annotation (stars) ===
pval <- stat_res$p.value
p.signif <- case_when(
  pval < 0.0001 ~ "****",
  pval < 0.001  ~ "***",
  pval < 0.01   ~ "**",
  pval < 0.05   ~ "*",
  TRUE          ~ "ns"
)

test_results <- tibble(
  group1_x = spacing_map["Control"],
  group2_x = spacing_map["TTX"],
  y.position = 0.5,
  p.signif = p.signif
)

# === Final plot ===
ggplot(Density, aes(x = x_pos, y = ERMCS_den, color = Condition)) +
  geom_beeswarm(cex = 10, priority = "random", size = 7, alpha = 0.8, corral = "random") +
  geom_boxplot(aes(group = x_pos), fill = NA, width = 1,
               outlier.shape = NA, size = 0.75, color = "black") +
  stat_summary(fun = mean, geom = "point", shape = 15, size = 7, color = "black") +
  geom_segment(data = test_results,
               aes(x = group1_x, xend = group2_x, y = y.position, yend = y.position),
               inherit.aes = FALSE, size = 1, color = "black") +
  geom_text(data = test_results,
            aes(x = (group1_x + group2_x)/2, y = y.position + 0.01, label = p.signif),
            inherit.aes = FALSE, size = 16, fontface = "bold") +
  scale_x_continuous(breaks = c(1, 2.2),
                     labels = c("control", "homeostatic\nscaling")) +
  scale_color_manual(values = c("grey20", "#0072B2")) +
  scale_y_continuous(
    breaks = c(0.1, 0.2, 0.3, 0.4, 0.5),
    expand = c(0, 0),
    limits = c(0.05, 0.55)
  ) +
  labs(x = "", y = "ERMCS/<br>total ER") +
  theme_classic() +
  theme(
    axis.title.y = element_markdown(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "transparent", color = NA),
    legend.position = "none",
    text = element_text(size = 30, color = "black", face = "bold"),
    axis.text.x = element_text(size = 30, face = "bold", color = "black"),
    axis.text.y = element_text(size = 30, face = "bold", color = "black"),
    axis.ticks = element_line(size = 1, color = "black"),
    axis.line = element_line(size = 0.5, colour = "black")
  )

```
<hr style="border:1px solid white"/>

**Fig 6 D (bottom)**

```{r}
# === Read and prepare data ===
Density <- read_csv("./ERMCS_Ribo_density.csv")

# === Mito per condition (check) ===
Density %>%
  count(Condition, name = "n_mito")


# === Normality and test selection ===
if (TRUE) {
  
  # 1. Shapiro-Wilk test for normality per group
  shapiro_results <- Density %>%
    group_by(Condition) %>%
    summarise(
      shapiro_p = shapiro.test(ER_den)$p.value,
      .groups = "drop"
    )
  shapiro_results
  
  # 2. If all groups pass Shapiro -> check variance with Levene
  if (all(shapiro_results$shapiro_p > 0.05)) {
    levene <- leveneTest(ER_den ~ Condition, data = Density, center = median)
    levene
    
    # 3a. Equal variances -> Student’s t-test
    if (levene$`Pr(>F)`[1] > 0.05) {
      stat_res <- t.test(ER_den ~ Condition, data = Density, var.equal = TRUE)
      test_used <- "Student's t-test"
      
    # 3b. Unequal variances -> Welch’s t-test
    } else {
      stat_res <- t.test(ER_den ~ Condition, data = Density, var.equal = FALSE)
      test_used <- "Welch's t-test"
    }
    
  # 4. If any group fails Shapiro -> Wilcoxon rank-sum
  } else {
    stat_res <- wilcox.test(ER_den ~ Condition, data = Density, exact = FALSE)
    test_used <- "Wilcoxon rank-sum test"
  }
  
  # Output
  test_used
  stat_res
}

# === Prepare data for plotting ===
spacing_map <- c("Control" = 1, "TTX" = 2.2)
Density <- Density %>%
  filter(Condition %in% names(spacing_map)) %>%
  mutate(
    x_pos = spacing_map[Condition],
    Condition = factor(Condition, levels = c("Control", "TTX"))
  )

# === Build annotation (stars) ===
pval <- stat_res$p.value
p.signif <- case_when(
  pval < 0.0001 ~ "****",
  pval < 0.001  ~ "***",
  pval < 0.01   ~ "**",
  pval < 0.05   ~ "*",
  TRUE          ~ "ns"
)

test_results <- tibble(
  group1_x = spacing_map["Control"],
  group2_x = spacing_map["TTX"],
  y.position = 6.1,
  p.signif = p.signif
)

# === Final plot ===
ggplot(Density, aes(x = x_pos, y = ER_den, color = Condition)) +
  geom_beeswarm(cex = 10, priority = "random", size = 7, alpha = 0.8, corral = "random") +
  geom_boxplot(aes(group = x_pos), fill = NA, width = 1,
               outlier.shape = NA, size = 0.75, color = "black") +
  stat_summary(fun = mean, geom = "point", shape = 15, size = 7, color = "black") +
  geom_segment(data = test_results,
               aes(x = group1_x, xend = group2_x, y = y.position, yend = y.position),
               inherit.aes = FALSE, size = 1, color = "black") +
  geom_text(data = test_results,
            aes(x = (group1_x + group2_x)/2, y = y.position + 0.6, label = p.signif),
            inherit.aes = FALSE, size = 16, fontface = "bold") +
  scale_x_continuous(breaks = c(1, 2.2),
                     labels = c("control", "homeostatic\nscaling")) +
  scale_color_manual(values = c("grey20", "#0072B2")) +
  scale_y_continuous(
    breaks = c(2, 4, 6),
    expand = c(0, 0),
    limits = c(0.6, 7)
  ) +
  labs(x = "", y = "ER density<br>(&micro;m<sup>-1</sup>)") +
  theme_classic() +
  theme(
    axis.title.y = element_markdown(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "transparent", color = NA),
    legend.position = "none",
    text = element_text(size = 30, color = "black", face = "bold"),
    axis.text.x = element_text(size = 30, face = "bold", color = "black"),
    axis.text.y = element_text(size = 30, face = "bold", color = "black"),
    axis.ticks = element_line(size = 1, color = "black"),
    axis.line = element_line(size = 0.5, colour = "black")
  )

```
<hr style="border:1px solid white"/>

**Fig 6 E**

```{r}
# === Read and prepare data ===
Density <- read_csv("./ERMCS_Ribo_density.csv") %>%drop_na()

# === Mito per condition (check) ===
Density %>%
  count(Condition, name = "n_mito")


# === Normality and test selection ===
if (TRUE) {
  
  # 1. Shapiro-Wilk test for normality per group
  shapiro_results <- Density %>%
    group_by(Condition) %>%
    summarise(
      shapiro_p = shapiro.test(Ribo_den)$p.value,
      .groups = "drop"
    )
  shapiro_results
  
  # 2. If all groups pass Shapiro -> run Welch’s t-test
  if (all(shapiro_results$shapiro_p > 0.05)) {
    levene <- leveneTest(Ribo_den ~ Condition, data = Density, center = median)
    levene
    
    stat_res <- t.test(Ribo_den ~ Condition, data = Density, var.equal = FALSE)
    test_used <- "Welch's t-test"
    
  # 3. If any group fails Shapiro -> Wilcoxon rank-sum
  } else {
    stat_res <- wilcox.test(Ribo_den ~ Condition, data = Density, exact = FALSE)
    test_used <- "Wilcoxon rank-sum test"
  }
  
  # Output
  test_used
  stat_res
}


# === Prepare data for plotting ===
spacing_map <- c("Control" = 1, "TTX" = 2.2)
Density <- Density %>%
  filter(Condition %in% names(spacing_map)) %>%
  mutate(
    x_pos = spacing_map[Condition],
    Condition = factor(Condition, levels = c("Control", "TTX"))
  )

# === Build annotation (stars) ===
pval <- stat_res$p.value
p.signif <- case_when(
  pval < 0.0001 ~ "****",
  pval < 0.001  ~ "***",
  pval < 0.01   ~ "**",
  pval < 0.05   ~ "*",
  TRUE          ~ "ns"
)

test_results <- tibble(
  group1_x = spacing_map["Control"],
  group2_x = spacing_map["TTX"],
  y.position = 95,
  p.signif = p.signif
)

# === Final plot ===
ggplot(Density, aes(x = x_pos, y = Ribo_den, color = Condition)) +
  geom_boxplot(aes(group = x_pos), fill = NA, width = 1,
               outlier.shape = NA, size = 0.75, color = "black") +
  geom_beeswarm(cex = 10, priority = "random", size = 7, alpha = 1, corral = "random") +
  stat_summary(fun = mean, geom = "point", shape = 15, size = 7, color = "black") +
  geom_segment(data = test_results,
               aes(x = group1_x, xend = group2_x, y = y.position, yend = y.position),
               inherit.aes = FALSE, size = 1, color = "black") +
  geom_text(data = test_results,
            aes(x = (group1_x + group2_x)/2, y = y.position + 5, label = p.signif),
            inherit.aes = FALSE, size = 16, fontface = "bold") +
  scale_x_continuous(breaks = c(1, 2.2),
                     labels = c("control", "homeostatic\nscaling")) +
  scale_color_manual(values = c("grey20", "#C71585")) +
  scale_y_continuous(
    breaks = c(0, 25, 50, 75, 100),
    expand = c(0, 0),
    limits = c(-5, 110)
  ) +
  labs(x = "", y = "ribosome density (&micro;m<sup>-1</sup>)") +
  theme_classic() +
  theme(
    axis.title.y = element_markdown(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "transparent", color = NA),
    legend.position = "none",
    text = element_text(size = 24, color = "black", face = "bold"),
    axis.text.x = element_text(size = 25, face = "bold", color = "black"),
    axis.text.y = element_text(size = 25, face = "bold", color = "black"),
    axis.ticks = element_line(size = 1, color = "black"),
    axis.line = element_line(size = 0.5, colour = "black")
  )

```

<hr style="border:1px solid white"/>

**Fig 6 F**

**Column Descriptions**

- **Condition**: experimental condition (e.g., *Control*, *TTX*)  
- **Mito_ID**: mito roi identifier within the condition 
- **ribo_cluster_id**: ribosome cluster identified within Mito_ID
- **surface_dist**: ribosome cluster surface to outer mito mesh surface distance in nm

```{r}
# === Read and prepare data ===
Density <- read_csv("./Ribo_distance.csv")
Density %>% arrange(Condition, Mito_ID)

# === Clusters per condition (check) ===
Density %>%
  count(Condition, name = "n_clusters")


# === Normality and test selection ===
if (TRUE) {
  
  # 1. Shapiro-Wilk test for normality per group
  shapiro_results <- Density %>%
    group_by(Condition) %>%
    summarise(
      shapiro_p = shapiro.test(surface_dist)$p.value,
      .groups = "drop"
    )
  shapiro_results
  
  # 2. If all groups pass Shapiro -> check variance with Levene
  if (all(shapiro_results$shapiro_p > 0.05)) {
    levene <- leveneTest(surface_dist ~ Condition, data = Density, center = median)
    levene
    
    # 3a. Equal variances -> Student’s t-test
    if (levene$`Pr(>F)`[1] > 0.05) {
      stat_res <- t.test(surface_dist ~ Condition, data = Density, var.equal = TRUE)
      test_used <- "Student's t-test"
      
    # 3b. Unequal variances -> Welch’s t-test
    } else {
      stat_res <- t.test(surface_dist ~ Condition, data = Density, var.equal = FALSE)
      test_used <- "Welch's t-test"
    }
    
  # 4. If any group fails Shapiro -> Wilcoxon rank-sum
  } else {
    stat_res <- wilcox.test(surface_dist ~ Condition, data = Density, exact = FALSE)
    test_used <- "Wilcoxon rank-sum test"
  }
  
  # Output
  test_used
  stat_res
}

# === Prepare data for plotting ===
spacing_map <- c("Control" = 1, "TTX" = 2.2)
Density <- Density %>%
  filter(Condition %in% names(spacing_map)) %>%
  mutate(
    x_pos = spacing_map[Condition],
    Condition = factor(Condition, levels = c("Control", "TTX"))
  )

# === Build annotation (stars) ===
pval <- stat_res$p.value
p.signif <- case_when(
  pval < 0.0001 ~ "****",
  pval < 0.001  ~ "***",
  pval < 0.01   ~ "**",
  pval < 0.05   ~ "*",
  TRUE          ~ "ns"
)

test_results <- tibble(
  group1_x = spacing_map["Control"],
  group2_x = spacing_map["TTX"],
  y.position = 620,
  p.signif = p.signif
)

# === Final plot ===
ggplot(Density, aes(x = x_pos, y = surface_dist, color = Condition)) +
  geom_beeswarm(cex = 10, priority = "random", size = 7, alpha = 0.8, corral = "random") +
  geom_boxplot(aes(group = x_pos), fill = NA, width = 1,
               outlier.shape = NA, size = 0.75, color = "black") +
  stat_summary(fun = mean, geom = "point", shape = 15, size = 7, color = "black") +
  geom_segment(data = test_results,
               aes(x = group1_x, xend = group2_x, y = y.position, yend = y.position),
               inherit.aes = FALSE, size = 1, color = "black") +
  geom_text(data = test_results,
            aes(x = (group1_x + group2_x)/2, y = y.position + 10, label = p.signif),
            inherit.aes = FALSE, size = 16, fontface = "bold") +
  scale_x_continuous(breaks = c(1, 2.2),
                     labels = c("control", "homeostatic\nscaling")) +
  scale_color_manual(values = c("grey20", "#C71585")) +
  scale_y_continuous(
    breaks = c(0, 200, 400, 600),
    expand = c(0, 0),
    limits = c(-50, 680)
  ) +
  labs(x = "", y = "ribosome cluster to<br>OMM distance (nm)") +
  theme_classic() +
  theme(
    axis.title.y = element_markdown(),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "transparent", color = NA),
    legend.position = "none",
    text = element_text(size = 25, color = "black", face = "bold"),
    axis.text.x = element_text(size = 25, face = "bold", color = "black"),
    axis.text.y = element_text(size = 25, face = "bold", color = "black"),
    axis.ticks = element_line(size = 1, color = "black"),
    axis.line = element_line(size = 0.5, colour = "black")
  )
```